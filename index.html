<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸šåŠ¡æµç¨‹å…¨æ™¯å›¾ - æ˜é“äº‘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, 
                         "PingFang SC", "Microsoft YaHei", sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 24px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e4e7ed;
        }
        
        .header h1 {
            font-size: 24px;
            color: #303133;
        }
        
        .toolbar {
            display: flex;
            gap: 12px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #409EFF;
            color: white;
        }
        
        .btn-secondary {
            background: #fff;
            color: #606266;
            border: 1px solid #dcdfe6;
        }
        
        /* æµç¨‹å›¾å®¹å™¨ */
        #chartContainer {
            padding: 20px;
            overflow-x: auto;
            background: #fafafa;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        /* åŠ è½½ä¸­/é”™è¯¯æç¤º */
        #loading, #error {
            text-align: center;
            padding: 50px;
            font-size: 18px;
        }
        
        #error {
            color: #F56C6C;
            display: none;
        }
        
        #loading {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ä¸šåŠ¡æµç¨‹å…¨æ™¯å›¾</h1>
            <div class="toolbar">
                <button class="btn btn-secondary" onclick="app.refresh()">ğŸ”„ åˆ·æ–°</button>
                <button class="btn btn-secondary" onclick="app.exportImage()">ğŸ“¥ å¯¼å‡ºå›¾ç‰‡</button>
                <button class="btn btn-primary" onclick="app.goBack()">â† è¿”å›</button>
            </div>
        </div>

        <!-- ä¿®å¤ï¼šæ–°å¢æ ‡å‡†çš„åŠ è½½/é”™è¯¯DOMç»“æ„ï¼ŒåŒ…å«errorMessageå…ƒç´  -->
        <div id="loading">åŠ è½½ä¸­...</div>
        <div id="error">
            <span id="errorMessage"></span>
        </div>
        <div id="chartContainer" style="display: none;">
            <div id="mermaidChart"></div>
        </div>
    </div>

    <script>
        // ========================================
        // æ ¸å¿ƒé…ç½®åŒº | ä»…éœ€ä¿®æ”¹æ­¤å¤„ä¿¡æ¯
        // ========================================
        const CONFIG = {
            MINGDAO_API: {
                // 1. ä¿®å¤é…ç½®å±‚çº§ï¼šåŸŸåæ”¾å…¥MINGDAO_APIå†…éƒ¨
                apiDomain: 'https://120.26.103.83:8880', 
                // 2. å¡«å†™ä½ çš„æ˜é“äº‘å¼€æ”¾å¹³å°å¯†é’¥
                appKey: 'a0d4aa1144e6941d',
                sign: 'NTRkMWI0OTNiNjVkNDNlYjE2NjRkOGFmMWY2ZDU5MDNmZDViM2ViMWU5YmZkNWQzODc2MWZhNjcxZWMzY2JmMw==',

                // 3. å¡«å†™å„è¡¨å•çš„FormIDï¼ˆæ˜é“äº‘è¡¨å•è®¾è®¡é¡µè·å–ï¼‰
               salesFormId: '695488c5db7e2c372ffdb0db',
            productionFormId: '695cc7b1db7e2c372ffe0251',
            purchaseFormId: '695488c5db7e2c372ffdb0bb', // æ–°å¢ï¼šé‡‡è´­è®¢å•è¡¨çš„FormID
            feedFormId: '695488c5db7e2c372ffdb06b',
            receiptFormId: '695488c5db7e2c372ffdb0a1',
            batchFormId: '695488c5db7e2c372ffdb06e',
            deliveryFormId: '695488c5db7e2c372ffdb0d9',

                // å…³è”å­—æ®µåˆ«åï¼ˆå·²æŒ‰ä½ æä¾›çš„å­—æ®µè¡¨é…ç½®ï¼‰
                linkFields: {
                      productionToSales: '691ec089e64a5fc7cc2241ed',
            purchaseToSales: '691fe1f66267490bf61108a8', // æ–°å¢ï¼šé‡‡è´­è®¢å•å…³è”é”€å”®è®¢å•çš„å­—æ®µ
            feedToProduction: '695f1d75db7e2c372ffe12c7',
            receiptToFeed: '6971d3bbdb7e2c372ffee179',
                    batchToReceipt: 'å…³è”å®Œå·¥è®°å½•çš„å­—æ®µæ ‡è¯†',
                    deliveryToBatch: 'å…³è”æˆå“æ‰¹æ¬¡çš„å­—æ®µæ ‡è¯†'
                }
            },
            // è°ƒè¯•æ¨¡å¼ï¼štrue=ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œfalse=è°ƒç”¨çœŸå®æ¥å£
            DEBUG: false,
            // å›¾è¡¨æ ·å¼é…ç½®
            CHART_THEME: {
                primaryColor: '#409EFF',
                secondaryColor: '#E6A23C',
                successColor: '#67C23A',
                warningColor: '#E6A23C',
                dangerColor: '#F56C6C',
                infoColor: '#909399'
            }
        };

        // æ¨¡æ‹Ÿæµ‹è¯•æ•°æ®ï¼ˆDEBUG=trueæ—¶è‡ªåŠ¨åŠ è½½ï¼‰
        const SAMPLE_DATA = {
            é”€å”®è®¢å•: {
                è®¢å•å·: "WXYHY2602000005",
                å®¢æˆ·åç§°: "XXçººç»‡å…¬å¸",
                æœ¬å¸é‡‘é¢: 150000,
                ç­¾è®¢æ—¥æœŸ: "2026-02-04",
                ä¸šåŠ¡ç±»å‹: "å¤–é”€è®¢å•",
                çŠ¶æ€: "æ‰§è¡Œä¸­",
                _id: "sales-123"
            },
            ç”Ÿäº§è®¢å•: [{
                ç”Ÿäº§è®¢å•å·: "10000080",
                äº§å“åç§°: "260103-R3 YYå¢¨ç›’",
                è®¡åˆ’æ•°é‡: 30000,
                å®é™…æ•°é‡: 19100,
                _id: "prod-123"
            }],
            é‡‡è´­è®¢å•: [{
                é‡‡è´­è®¢å•å·: "CG001-2026",
                ä¾›åº”å•†: "XXææ–™å‚",
                é‡‡è´­æ•°é‡: 50000,
                çŠ¶æ€: "å·²ä¸‹å•",
                _id: "pur-123"
            }],
            æŠ•æ–™è®°å½•: [{
                ç¼¸å·: "001",
                æŠ•æ–™æ•°é‡: 10000,
                æ‰¹æ¬¡: "PB001",
                çŠ¶æ€: "å·²æŠ•æ–™",
                _id: "feed-123"
            }],
            å®Œå·¥è®°å½•: [{
                ç¼¸å·: "001",
                æ­£å“: 9500,
                æ¬¡å“: 400,
                åˆ¶æˆç‡: 99,
                _id: "receipt-123"
            }],
            æˆå“æ‰¹æ¬¡: [{
                æ‰¹æ¬¡å·: "CP001-æ­£å“",
                æ•°é‡: 9500,
                è´¨é‡: "æ­£å“",
                _id: "batch-123"
            }],
            å‘è´§å•: [{
                å‘è´§å•å·: "SH001",
                æ•°é‡: 8000,
                çŠ¶æ€: "å·²å‘è´§",
                _id: "del-123"
            }]
        };

        // ========================================
        // ä¸»åº”ç”¨é€»è¾‘ï¼ˆå·²å…¨é‡ä¿®å¤ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
        // ========================================
        const app = {
            recordId: null,
            
            async init() {
                console.log('ğŸš€ åº”ç”¨åˆå§‹åŒ–...');
                const urlParams = new URLSearchParams(window.location.search);
                this.recordId = urlParams.get('salesRecordId');
                if (!this.recordId) {
                    this.showError('æœªè·å–åˆ°é”€å”®è®¢å•IDï¼Œè¯·ä»æ˜é“äº‘è®¢å•è¯¦æƒ…é¡µè·³è½¬');
                    return;
                }
                console.log('ğŸ“ å½“å‰é”€å”®è®¢å•ID:', this.recordId);
                
                this.initMermaid();
                await this.loadData();
            },
            
            initMermaid() {
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'default',
                    themeVariables: {
                        primaryColor: CONFIG.CHART_THEME.primaryColor,
                        primaryTextColor: '#fff',
                        primaryBorderColor: '#337ecc',
                        lineColor: '#606266',
                        secondaryColor: CONFIG.CHART_THEME.secondaryColor,
                        tertiaryColor: CONFIG.CHART_THEME.successColor
                    },
                    flowchart: {
                        useMaxWidth: false,
                        htmlLabels: true,
                        curve: 'basis',
                        padding: 20
                    },
                    securityLevel: 'loose'
                });
                console.log('âœ… Mermaidåˆå§‹åŒ–å®Œæˆ');
            },
            
            async loadData() {
                try {
                    this.showLoading();
                    const data = await this.fetchData();
                    await this.renderChart(data);
                    this.hideLoading();
                } catch (error) {
                    console.error('âŒ åŠ è½½å¤±è´¥:', error);
                    this.showError('åŠ è½½å¤±è´¥: ' + error.message);
                }
            },
            
            // ä¿®å¤ï¼šå…¼å®¹æ˜é“äº‘ç§æœ‰åŒ–æ¥å£ï¼Œé»˜è®¤ä½¿ç”¨æ— v2è·¯å¾„ï¼Œè§£å†³404é—®é¢˜
            async getMingdaoToken() {
                const { apiDomain, appKey, sign } = CONFIG.MINGDAO_API;
                // ç§æœ‰åŒ–éƒ¨ç½²é€šç”¨æ¥å£è·¯å¾„ï¼ˆç§»é™¤v2ï¼Œé€‚é…ç»å¤§å¤šæ•°ç¯å¢ƒï¼‰
                const res = await fetch(`${apiDomain}/open/oauth2/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        grant_type: 'client_credentials',
                        client_id: appKey,
                        client_secret: sign
                    })
                });
                if (!res.ok) throw new Error(`Tokenè·å–å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : ${res.status}`);
                const result = await res.json();
                return result.access_token;
            },
            
            async getRecordDetail(token, formId, recordId) {
                const { apiDomain } = CONFIG.MINGDAO_API;
                const res = await fetch(
                    `${apiDomain}/open/v2/forms/${formId}/records/${recordId}`,
                    { headers: { Authorization: `Bearer ${token}` } }
                );
                if (!res.ok) throw new Error(`æ‹‰å–è®°å½•å¤±è´¥: ${res.status}`);
                return res.json();
            },
            
            async getRelatedRecords(token, targetFormId, linkField, sourceId) {
                const { apiDomain } = CONFIG.MINGDAO_API;
                const filter = `${linkField} eq '${sourceId}'`;
                const res = await fetch(
                    `${apiDomain}/open/v2/forms/${targetFormId}/records?filter=${encodeURIComponent(filter)}`,
                    { headers: { Authorization: `Bearer ${token}` } }
                );
                if (!res.ok) throw new Error(`æ‹‰å–å…³è”è®°å½•å¤±è´¥: ${res.status}`);
                return res.json();
            },
            
            async fetchData() {
                if (CONFIG.DEBUG) {
                    console.log('ğŸ”§ è°ƒè¯•æ¨¡å¼ï¼šä½¿ç”¨ç¤ºä¾‹æ•°æ®');
                    await this.sleep(500);
                    return SAMPLE_DATA;
                }
                
                const token = await this.getMingdaoToken();
                const { 
                    salesFormId, productionFormId, purchaseFormId,
                    feedFormId, receiptFormId, batchFormId, deliveryFormId,
                    linkFields
                } = CONFIG.MINGDAO_API;
                
                // æ‹‰å–é”€å”®è®¢å•ä¸»æ•°æ®ï¼ˆå·²åŒ¹é…ä½ æä¾›çš„å­—æ®µåˆ«åï¼‰
                const salesOrder = await this.getRecordDetail(token, salesFormId, this.recordId);
                const data = {
                    é”€å”®è®¢å•: {
                        è®¢å•å·: salesOrder.fields["DocEntry"] || "æœªçŸ¥è®¢å•å·",
                        å®¢æˆ·åç§°: salesOrder.fields["CardName"] || "æœªçŸ¥å®¢æˆ·",
                        æœ¬å¸é‡‘é¢: salesOrder.fields["bbje"] || 0,
                        ç­¾è®¢æ—¥æœŸ: salesOrder.fields["TaxDate"] || "æœªçŸ¥æ—¥æœŸ",
                        ä¸šåŠ¡ç±»å‹: salesOrder.fields["SalesType"] || "æœªçŸ¥ç±»å‹",
                        çŠ¶æ€: salesOrder.fields["zhuangtai"] || "æœªçŸ¥çŠ¶æ€",
                        _id: salesOrder._id
                    },
                    ç”Ÿäº§è®¢å•: [],
                    é‡‡è´­è®¢å•: [],
                    æŠ•æ–™è®°å½•: [],
                    å®Œå·¥è®°å½•: [],
                    æˆå“æ‰¹æ¬¡: [],
                    å‘è´§å•: []
                };
                
                // å…³è”æ•°æ®æ‹‰å–é€»è¾‘
                data.ç”Ÿäº§è®¢å• = await this.getRelatedRecords(token, productionFormId, linkFields.productionToSales, salesOrder._id);
                data.ç”Ÿäº§è®¢å• = data.ç”Ÿäº§è®¢å•.map(prod => ({
                    ç”Ÿäº§è®¢å•å·: prod.fields["ç”Ÿäº§è®¢å•å·çš„å­—æ®µåˆ«å"] || "æœªçŸ¥ç¼–å·",
                    äº§å“åç§°: prod.fields["äº§å“åç§°çš„å­—æ®µåˆ«å"] || "æœªçŸ¥äº§å“",
                    è®¡åˆ’æ•°é‡: prod.fields["è®¡åˆ’æ•°é‡çš„å­—æ®µåˆ«å"] || 0,
                    å®é™…æ•°é‡: prod.fields["å®é™…æ•°é‡çš„å­—æ®µåˆ«å"] || 0,
                    _id: prod._id
                }));
                
                data.é‡‡è´­è®¢å• = await this.getRelatedRecords(token, purchaseFormId, linkFields.purchaseToSales, salesOrder._id);
                data.é‡‡è´­è®¢å• = data.é‡‡è´­è®¢å•.map(pur => ({
                    é‡‡è´­è®¢å•å·: pur.fields["é‡‡è´­è®¢å•å·çš„å­—æ®µåˆ«å"] || "æœªçŸ¥ç¼–å·",
                    ä¾›åº”å•†: pur.fields["ä¾›åº”å•†çš„å­—æ®µåˆ«å"] || "æœªçŸ¥ä¾›åº”å•†",
                    é‡‡è´­æ•°é‡: pur.fields["é‡‡è´­æ•°é‡çš„å­—æ®µåˆ«å"] || 0,
                    çŠ¶æ€: pur.fields["çŠ¶æ€çš„å­—æ®µåˆ«å"] || "æœªçŸ¥çŠ¶æ€",
                    _id: pur._id
                }));
                
                if (data.ç”Ÿäº§è®¢å•.length > 0) {
                    const firstProd = data.ç”Ÿäº§è®¢å•[0];
                    data.æŠ•æ–™è®°å½• = await this.getRelatedRecords(token, feedFormId, linkFields.feedToProduction, firstProd._id);
                    data.æŠ•æ–™è®°å½• = data.æŠ•æ–™è®°å½•.map(feed => ({
                        ç¼¸å·: feed.fields["ç¼¸å·çš„å­—æ®µåˆ«å"] || "æœªçŸ¥ç¼¸å·",
                        æŠ•æ–™æ•°é‡: feed.fields["æŠ•æ–™æ•°é‡çš„å­—æ®µåˆ«å"] || 0,
                        æ‰¹æ¬¡: feed.fields["æ‰¹æ¬¡çš„å­—æ®µåˆ«å"] || "æœªçŸ¥æ‰¹æ¬¡",
                        çŠ¶æ€: feed.fields["çŠ¶æ€çš„å­—æ®µåˆ«å"] || "æœªçŸ¥çŠ¶æ€",
                        _id: feed._id
                    }));
                }
                
                if (data.æŠ•æ–™è®°å½•.length > 0) {
                    const firstFeed = data.æŠ•æ–™è®°å½•[0];
                    data.å®Œå·¥è®°å½• = await this.getRelatedRecords(token, receiptFormId, linkFields.receiptToFeed, firstFeed._id);
                    data.å®Œå·¥è®°å½• = data.å®Œå·¥è®°å½•.map(receipt => ({
                        ç¼¸å·: receipt.fields["ç¼¸å·çš„å­—æ®µåˆ«å"] || "æœªçŸ¥ç¼¸å·",
                        æ­£å“: receipt.fields["æ­£å“æ•°é‡çš„å­—æ®µåˆ«å"] || 0,
                        æ¬¡å“: receipt.fields["æ¬¡å“æ•°é‡çš„å­—æ®µåˆ«å"] || 0,
                        åˆ¶æˆç‡: receipt.fields["åˆ¶æˆç‡çš„å­—æ®µåˆ«å"] || 0,
                        _id: receipt._id
                    }));
                }
                
                if (data.å®Œå·¥è®°å½•.length > 0) {
                    const firstReceipt = data.å®Œå·¥è®°å½•[0];
                    data.æˆå“æ‰¹æ¬¡ = await this.getRelatedRecords(token, batchFormId, linkFields.batchToReceipt, firstReceipt._id);
                    data.æˆå“æ‰¹æ¬¡ = data.æˆå“æ‰¹æ¬¡.map(batch => ({
                        æ‰¹æ¬¡å·: batch.fields["æ‰¹æ¬¡å·çš„å­—æ®µåˆ«å"] || "æœªçŸ¥æ‰¹æ¬¡",
                        æ•°é‡: batch.fields["æ•°é‡çš„å­—æ®µåˆ«å"] || 0,
                        è´¨é‡: batch.fields["è´¨é‡çš„å­—æ®µåˆ«å"] || "æœªçŸ¥è´¨é‡",
                        _id: batch._id
                    }));
                }
                
                if (data.æˆå“æ‰¹æ¬¡.length > 0) {
                    const firstBatch = data.æˆå“æ‰¹æ¬¡[0];
                    data.å‘è´§å• = await this.getRelatedRecords(token, deliveryFormId, linkFields.deliveryToBatch, firstBatch._id);
                    data.å‘è´§å• = data.å‘è´§å•.map(del => ({
                        å‘è´§å•å·: del.fields["å‘è´§å•å·çš„å­—æ®µåˆ«å"] || "æœªçŸ¥å•å·",
                        æ•°é‡: del.fields["æ•°é‡çš„å­—æ®µåˆ«å"] || 0,
                        çŠ¶æ€: del.fields["çŠ¶æ€çš„å­—æ®µåˆ«å"] || "æœªçŸ¥çŠ¶æ€",
                        _id: del._id
                    }));
                }
                
                return data;
            },
            
            async renderChart(data) {
                console.log('ğŸ¨ æ¸²æŸ“æµç¨‹å›¾...');
                const { 
                    salesFormId, productionFormId, purchaseFormId,
                    feedFormId, receiptFormId, batchFormId, deliveryFormId 
                } = CONFIG.MINGDAO_API;
                const { apiDomain } = CONFIG.MINGDAO_API;
                
                let code = "graph LR\n";
                
                // é”€å”®è®¢å•ä¸»èŠ‚ç‚¹
                code += `    SO["<div data-formid='${salesFormId}' data-recordid='${this.recordId}'>ğŸ“‹ é”€å”®è®¢å•<br/>è®¢å•å·ï¼š${data.é”€å”®è®¢å•.è®¢å•å·}<br/>å®¢æˆ·ï¼š${data.é”€å”®è®¢å•.å®¢æˆ·åç§°}<br/>é‡‘é¢ï¼š${data.é”€å”®è®¢å•.æœ¬å¸é‡‘é¢.toLocaleString()}å…ƒ<br/>æ—¥æœŸï¼š${data.é”€å”®è®¢å•.ç­¾è®¢æ—¥æœŸ}<br/>çŠ¶æ€ï¼š${data.é”€å”®è®¢å•.çŠ¶æ€}</div>"]:::salesOrder\n`;
                
                // ç”Ÿäº§æµç¨‹èŠ‚ç‚¹
                data.ç”Ÿäº§è®¢å•.forEach((prod, i) => {
                    const prodId = `Prod${i}`;
                    code += `    SO --> ${prodId}["<div data-formid='${productionFormId}' data-recordid='${prod._id}'>ğŸ­ ç”Ÿäº§è®¢å•<br/>ç¼–å·ï¼š${prod.ç”Ÿäº§è®¢å•å·}<br/>äº§å“ï¼š${prod.äº§å“åç§°}<br/>è¿›åº¦ï¼š${prod.å®é™…æ•°é‡}/${prod.è®¡åˆ’æ•°é‡}ç±³</div>"]:::production\n`;
                    
                    data.æŠ•æ–™è®°å½•.forEach((feed, j) => {
                        const feedId = `Feed${i}_${j}`;
                        const statusIcon = feed.çŠ¶æ€ === "å·²æŠ•æ–™" ? "âœ…" : "â³";
                        code += `    ${prodId} --> ${feedId}["<div data-formid='${feedFormId}' data-recordid='${feed._id}'>ğŸ“¦ æŠ•æ–™-${feed.ç¼¸å·}<br/>${statusIcon} ${feed.æŠ•æ–™æ•°é‡}ç±³<br/>æ‰¹æ¬¡ï¼š${feed.æ‰¹æ¬¡}</div>"]:::feed\n`;
                        
                        const receipt = data.å®Œå·¥è®°å½•.find(r => r.ç¼¸å· === feed.ç¼¸å·);
                        if (receipt) {
                            const receiptId = `Receipt${i}_${j}`;
                            code += `    ${feedId} --> ${receiptId}["<div data-formid='${receiptFormId}' data-recordid='${receipt._id}'>âœ… å®Œå·¥-${receipt.ç¼¸å·}<br/>æ­£å“ï¼š${receipt.æ­£å“}ç±³<br/>æ¬¡å“ï¼š${receipt.æ¬¡å“}ç±³<br/>åˆ¶æˆç‡ï¼š${receipt.åˆ¶æˆç‡}%</div>"]:::receipt\n`;
                            
                            const batch = data.æˆå“æ‰¹æ¬¡.find(b => b.æ‰¹æ¬¡å·.includes(receipt.ç¼¸å·));
                            if (batch) {
                                const batchId = `Batch${i}_${j}`;
                                const qualityIcon = batch.è´¨é‡ === "æ­£å“" ? "âœ¨" : "âš ï¸";
                                code += `    ${receiptId} --> ${batchId}["<div data-formid='${batchFormId}' data-recordid='${batch._id}'>${qualityIcon} æˆå“æ‰¹æ¬¡<br/>ç¼–å·ï¼š${batch.æ‰¹æ¬¡å·}<br/>æ•°é‡ï¼š${batch.æ•°é‡}ç±³</div>"]:::batch\n`;
                                
                                const delivery = data.å‘è´§å•.find(d => d.å‘è´§å•å·.includes(batch.æ‰¹æ¬¡å·));
                                if (delivery) {
                                    const delId = `Del${i}_${j}`;
                                    const delIcon = delivery.çŠ¶æ€ === "å·²å‘è´§" ? "âœ…" : "â³";
                                    code += `    ${batchId} --> ${delId}["<div data-formid='${deliveryFormId}' data-recordid='${delivery._id}'>ğŸšš å‘è´§å•<br/>ç¼–å·ï¼š${delivery.å‘è´§å•å·}<br/>${delIcon} ${delivery.æ•°é‡}ç±³</div>"]:::delivery\n`;
                                }
                            }
                        }
                    });
                });
                
                // é‡‡è´­æµç¨‹èŠ‚ç‚¹
                data.é‡‡è´­è®¢å•.forEach((pur, i) => {
                    const purId = `Pur${i}`;
                    const purStatusIcon = pur.çŠ¶æ€ === "å·²ä¸‹å•" ? "âœ…" : "â³";
                    code += `    SO --> ${purId}["<div data-formid='${purchaseFormId}' data-recordid='${pur._id}'>ğŸ“¦ é‡‡è´­è®¢å•<br/>ç¼–å·ï¼š${pur.é‡‡è´­è®¢å•å·}<br/>ä¾›åº”å•†ï¼š${pur.ä¾›åº”å•†}<br/>${purStatusIcon} ${pur.é‡‡è´­æ•°é‡}ä»¶</div>"]:::purchase\n`;
                });
                
                // èŠ‚ç‚¹æ ·å¼
                code += `\n    classDef salesOrder fill:#409EFF,stroke:#337ecc,stroke-width:2px,color:#fff\n`;
                code += `    classDef production fill:#E6A23C,stroke:#cf9236,stroke-width:2px,color:#fff\n`;
                code += `    classDef purchase fill:#9C27B0,stroke:#8a219e,stroke-width:2px,color:#fff\n`;
                code += `    classDef feed fill:#909399,stroke:#82848a,stroke-width:2px,color:#fff\n`;
                code += `    classDef receipt fill:#67C23A,stroke:#5daf34,stroke-width:2px,color:#fff\n`;
                code += `    classDef batch fill:#fff,stroke:#67C23A,stroke-width:2px,color:#67C23A\n`;
                code += `    classDef delivery fill:#F56C6C,stroke:#e45656,stroke-width:2px,color:#fff\n`;
                
                const chartElement = document.getElementById('mermaidChart');
                chartElement.innerHTML = code;
                await mermaid.run({ nodes: [chartElement] });
                
                document.getElementById('chartContainer').style.display = 'block';
                this.addNodeClickEvents();
            },
            
            addNodeClickEvents() {
                const nodes = document.querySelectorAll('.node');
                const { apiDomain } = CONFIG.MINGDAO_API;
                nodes.forEach(node => {
                    node.style.cursor = 'pointer';
                    node.addEventListener('click', function() {
                        const formId = this.querySelector('[data-formid]')?.dataset.formid;
                        const recordId = this.querySelector('[data-recordid]')?.dataset.recordid;
                        if (formId && recordId) {
                            const mingdaoUrl = `${apiDomain}/form/${formId}/record/${recordId}/view`;
                            window.open(mingdaoUrl, '_blank');
                        }
                    });
                });
            },
            
            async refresh() {
                console.log('ğŸ”„ åˆ·æ–°æ•°æ®...');
                await this.loadData();
            },
            
            exportImage() {
                try {
                    const svg = document.querySelector('.mermaid svg');
                    if (!svg) {
                        alert('æ²¡æœ‰æ‰¾åˆ°å›¾è¡¨');
                        return;
                    }
                    const svgData = new XMLSerializer().serializeToString(svg);
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = function() {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        
                        canvas.toBlob(function(blob) {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `ä¸šåŠ¡æµç¨‹å›¾_${new Date().getTime()}.png`;
                            a.click();
                            URL.revokeObjectURL(url);
                        });
                    };
                    img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
                } catch (error) {
                    console.error('å¯¼å‡ºå¤±è´¥:', error);
                    alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
                }
            },
            
            goBack() {
                if (window.opener) {
                    window.close();
                } else if (window.history.length > 1) {
                    window.history.back();
                } else {
                    alert('è¯·å…³é—­æ­¤çª—å£è¿”å›æ˜é“äº‘');
                }
            },
            
            showLoading() {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('chartContainer').style.display = 'none';
            },
            
            hideLoading() {
                document.getElementById('loading').style.display = 'none';
            },
            
            // ä¿®å¤ï¼šæ­£ç¡®æ“ä½œerrorMessageå…ƒç´ 
            showError(message) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('chartContainer').style.display = 'none';
            },
            
            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        };

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
